#include "koi8r.h"


// koi8-r -> utf-8
static unsigned char utf8[128][3] = {
    {226, 148, 128},
    {226, 148, 130},
    {226, 148, 140},
    {226, 148, 144},
    {226, 148, 148},
    {226, 148, 152},
    {226, 148, 156},
    {226, 148, 164},

    {226, 148, 172},
    {226, 148, 180},
    {226, 148, 188},
    {226, 150, 128},
    {226, 150, 132},
    {226, 150, 136},
    {226, 150, 140},
    {226, 150, 144},

    {226, 150, 145},
    {226, 150, 146},
    {226, 150, 147},
    {226, 140, 160},
    {226, 150, 160},
    {226, 136, 153},
    {226, 136, 154},
    {226, 137, 136},

    {226, 137, 164},
    {226, 137, 165},
    {194, 160, 0},
    {226, 140, 161},
    {194, 176, 0},
    {194, 178, 0},
    {194, 183, 0},
    {195, 183, 0},

    {226, 149, 144},
    {226, 149, 145},
    {226, 149, 146},
    {209, 145, 0},
    {226, 149, 147},
    {226, 149, 148},
    {226, 149, 149},
    {226, 149, 150},

    {226, 149, 151},
    {226, 149, 152},
    {226, 149, 153},
    {226, 149, 154},
    {226, 149, 155},
    {226, 149, 156},
    {226, 149, 157},
    {226, 149, 158},

    {226, 149, 159},
    {226, 149, 160},
    {226, 149, 161},
    {208, 129, 0},
    {226, 149, 162},
    {226, 149, 163},
    {226, 149, 164},
    {226, 149, 165},

    {226, 149, 166},
    {226, 149, 167},
    {226, 149, 168},
    {226, 149, 169},
    {226, 149, 170},
    {226, 149, 171},
    {226, 149, 172},
    {194, 169, 0},

    {209, 142, 0},
    {208, 176, 0},
    {208, 177, 0},
    {209, 134, 0},
    {208, 180, 0},
    {208, 181, 0},
    {209, 132, 0},
    {208, 179, 0},

    {209, 133, 0},
    {208, 184, 0},
    {208, 185, 0},
    {208, 186, 0},
    {208, 187, 0},
    {208, 188, 0},
    {208, 189, 0},
    {208, 190, 0},

    {208, 191, 0},
    {209, 143, 0},
    {209, 128, 0},
    {209, 129, 0},
    {209, 130, 0},
    {209, 131, 0},
    {208, 182, 0},
    {208, 178, 0},

    {209, 140, 0},
    {209, 139, 0},
    {208, 183, 0},
    {209, 136, 0},
    {209, 141, 0},
    {209, 137, 0},
    {209, 135, 0},
    {209, 138, 0},

    {208, 174, 0},
    {208, 144, 0},
    {208, 145, 0},
    {208, 166, 0},
    {208, 148, 0},
    {208, 149, 0},
    {208, 164, 0},
    {208, 147, 0},

    {208, 165, 0},
    {208, 152, 0},
    {208, 153, 0},
    {208, 154, 0},
    {208, 155, 0},
    {208, 156, 0},
    {208, 157, 0},
    {208, 158, 0},

    {208, 159, 0},
    {208, 175, 0},
    {208, 160, 0},
    {208, 161, 0},
    {208, 162, 0},
    {208, 163, 0},
    {208, 150, 0},
    {208, 146, 0},

    {208, 172, 0},
    {208, 171, 0},
    {208, 151, 0},
    {208, 168, 0},
    {208, 173, 0},
    {208, 169, 0},
    {208, 167, 0},
    {208, 170, 0}
};


// koi8-r -> ibm866
static unsigned char ibm866[128] = {
    196, 179, 218, 191, 192, 217, 195, 180,
    194, 193, 197, 223, 220, 219, 221, 222,
    176, 177, 178, 244, 254, 249, 251, 247,
    243, 242, 255, 245, 248, 253, 250, 246,
    205, 186, 213, 241, 214, 201, 184, 183,
    187, 212, 211, 200, 190, 189, 188, 198,
    199, 204, 181, 240, 182, 185, 209, 210,
    203, 207, 208, 202, 216, 215, 206, 252,
    238, 160, 161, 230, 164, 165, 228, 163,
    229, 168, 169, 170, 171, 172, 173, 174,
    175, 239, 224, 225, 226, 227, 166, 162,
    236, 235, 167, 232, 237, 233, 231, 234,
    158, 128, 129, 150, 132, 133, 148, 131,
    149, 136, 137, 138, 139, 140, 141, 142,
    143, 159, 144, 145, 146, 147, 134, 130,
    156, 155, 135, 152, 157, 153, 151, 154
};


// koi8-r -> win1251
static unsigned char win1251[128] = {
    128, 129, 130, 131, 132, 133, 134, 135,
    136, 137, 138, 139, 140, 141, 142, 143,
    144, 145, 146, 147, 148, 149, 150, 151,
    152, 153, 218, 155, 176, 157, 183, 159,
    160, 161, 162, 184, 186, 165, 166, 191,
    168, 169, 170, 171, 172, 173, 174, 175,
    156, 177, 178, 168, 170, 181, 182, 175,
    184, 185, 186, 187, 188, 189, 190, 185,
    254, 224, 225, 246, 228, 229, 244, 227,
    245, 232, 233, 234, 235, 236, 237, 238,
    239, 255, 240, 241, 242, 243, 230, 226,
    252, 251, 231, 248, 253, 249, 247, 250,
    222, 192, 193, 214, 196, 197, 212, 195,
    213, 200, 201, 202, 203, 204, 205, 206,
    207, 223, 208, 209, 210, 211, 198, 194,
    220, 219, 199, 216, 221, 217, 215, 218
};


/* Translate koi8-r string to utf-8 string.
 * String can be truncated if there is not enough buffer size.
 *
 * In:
 *      str - source string in koi8-r encoding
 *      buf - ptr to receiving buffer
 *      size - buffer size
 * Return:
 *      number of bytes written to buffer
 */
size_t koi8r_to_utf8(const char *str, char *buf, size_t size) {
    const unsigned char *s = (const unsigned char*)str;
    unsigned char *d = (unsigned char*)buf;
    size_t dlen = 0;
    size--;

    for (; *s; s++) {
        unsigned char c = *s;
        if (c < 0x80) {
            if (dlen >= size) break;
            d[dlen++] = c;
        } else {
            unsigned char *u = utf8[c-0x80];
            if (u[0] < 0xE0) {
                if (dlen + 2 >= size) break;
                d[dlen++] = u[0];
                d[dlen++] = u[1];
            } else {
                if (dlen + 3 >= size) break;
                d[dlen++] = u[0];
                d[dlen++] = u[1];
                d[dlen++] = u[2];
            }
        }
    }

    d[dlen] = 0;
    return dlen;
}


/* Translate koi8-r string to ibm866 string.
 * String can be truncated if there is not enough buffer size.
 *
 * In:
 *      str - source string in koi8-r encoding
 *      buf - ptr to receiving buffer
 *      size - buffer size
 * Return:
 *      number of bytes written to buffer
 */
size_t koi8r_to_866(const char *str, char *buf, size_t size) {
    const unsigned char *s = (const unsigned char*)str;
    unsigned char *d = (unsigned char*)buf;
    size_t dlen = 0;
    size--;

    for (; *s && dlen < size; s++) {
        unsigned char c = *s;
        if (c < 0x80) {
            d[dlen++] = c;
        } else {
            d[dlen++] = ibm866[c-0x80];
        }
    }

    d[dlen] = 0;
    return dlen;
}


/* Translate koi8-r string to win1251 string.
 * String can be truncated if there is not enough buffer size.
 *
 * In:
 *      str - source string in koi8-r encoding
 *      buf - ptr to receiving buffer
 *      size - buffer size
 * Return:
 *      number of bytes written to buffer
 */
size_t koi8r_to_1251(const char *str, char *buf, size_t size) {
    const unsigned char *s = (const unsigned char*)str;
    unsigned char *d = (unsigned char*)buf;
    size_t dlen = 0;
    size--;

    for (; *s && dlen < size; s++) {
        unsigned char c = *s;
        if (c < 0x80) {
            d[dlen++] = c;
        } else {
            d[dlen++] = win1251[c-0x80];
        }
    }

    d[dlen] = 0;
    return dlen;
}
